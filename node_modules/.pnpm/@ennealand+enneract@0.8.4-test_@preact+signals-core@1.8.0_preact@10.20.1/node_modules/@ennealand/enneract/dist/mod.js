var Ce=Object.defineProperty;var Ee=(l,e)=>{for(var t in e)Ce(l,t,{get:e[t],enumerable:!0})};var N={};Ee(N,{SupportedContetTypes:()=>Re});var Re=["int","float","string","binary"];var S=class extends ReferenceError{constructor(){super("Cannot perform operation when connection is closed.")}},G=class{constructor(e,t){this.url=e;this.options=t;this.connect()}ws;resolveHealthcheck;queue=new Map;eventsQueue=new Map;messageCounter=0;connected;closed;keynodes=new Map;hangingOperations=new Set;connect(){this.ws=new WebSocket(this.url),this.ws.onmessage=this.onMessage,this.connected=new Promise(e=>{this.ws.onopen=t=>{this.onConnect(t),e(!0)}}),this.closed=new Promise(e=>{this.ws.onclose=t=>{this.onDisconnect(t),e(!0)}})}healthCheckInterval=void 0;onConnect(e){console.log("Enneract: connection opened"),clearInterval(this.healthCheckInterval),this.healthCheckInterval=setInterval(async()=>{await this.send("healthcheck",null)||console.warn("Sc-machine is not healthy")},12e4)}onDisconnect(e){console.log(`Enneract: connection closed (${e.reason})`),this.options?.reconnect&&new Promise(t=>setTimeout(t,1e3)).then(()=>{this.connect()})}onMessage=e=>{if(e.data==='"OK"'||e.data==='"NO"'){this.resolveHealthcheck?.(e.data==='"OK"');return}let{id:t,event:s,payload:r,errors:n}=JSON.parse(e.data);if(s){let i=this.eventsQueue.get(t);i&&i(r);return}let a=this.queue.get(t);a&&(this.queue.delete(t),n?.length&&console.log(`%c${n}`,"color:red"),a(r))};async subscribe(e,t){let s=await this.send("events",{create:e});for(let[r,n]of s.entries())this.eventsQueue.set(n,t.bind(null,r));return s}async unsubscribe(e){let t=this.send("events",{delete:e});this.hangingOperations.add(t);for(let s of e)this.eventsQueue.delete(s);return await t.then(s=>(this.hangingOperations.delete(t),s))}async send(e,t){if(await this.connected,this.ws.readyState!==this.ws.OPEN)throw new S;return this.messageCounter++,this.ws.send(JSON.stringify({type:e.split(":")[0],payload:t,id:this.messageCounter})),e==="healthcheck"?new Promise(s=>this.resolveHealthcheck=s):new Promise(s=>this.queue.set(this.messageCounter,s))}async getKeynode(e){let t=this.keynodes.get(e);try{if(t||(t=this.send("keynodes",[{command:"find",idtf:e}]).then(([s])=>s),this.keynodes.set(e,t)),!await t)throw new TypeError(`Keynode '${e}' does not exist`);return await t}catch(s){throw s}}async disconnect(){if(this.hangingOperations.size&&(console.log("%cWaiting for hanging operations to complete...","color: grey"),await Promise.allSettled(this.hangingOperations)),this.eventsQueue.size){let e=Array.from(this.eventsQueue.keys());console.log(`%cCleaning up all hanging agents (${e.join(", ")})`,"color: grey"),await this.unsubscribe(e)}this.ws.close(1e3,"disconnect"),await this.closed}};var v=1,ee=3;var Q=16388;var B=49160,M=49168,E=32,R=64,z=49296,U=49424,K=49680,L=50192,W=51216,te=128,ne=256,se=512,re=1024,ie=2048,ae=4096,oe=8192,k=(o=>(o[o.EdgeUCommon=Q]="EdgeUCommon",o[o.EdgeDCommon=B]="EdgeDCommon",o[o.EdgeUCommonConst=Q|E]="EdgeUCommonConst",o[o.EdgeDCommonConst=B|E]="EdgeDCommonConst",o[o.EdgeUCommonVar=Q|R]="EdgeUCommonVar",o[o.EdgeDCommonVar=B|R]="EdgeDCommonVar",o[o.EdgeAccess=M]="EdgeAccess",o[o.EdgeAccessConstPosPerm=E|M|W|z]="EdgeAccessConstPosPerm",o[o.EdgeAccessConstNegPerm=E|M|W|U]="EdgeAccessConstNegPerm",o[o.EdgeAccessConstFuzPerm=E|M|K]="EdgeAccessConstFuzPerm",o[o.EdgeAccessConstPosTemp=E|M|L|z]="EdgeAccessConstPosTemp",o[o.EdgeAccessConstNegTemp=E|M|L|U]="EdgeAccessConstNegTemp",o[o.EdgeAccessConstFuzTemp=E|M|K]="EdgeAccessConstFuzTemp",o[o.EdgeAccessVarPosPerm=R|M|W|z]="EdgeAccessVarPosPerm",o[o.EdgeAccessVarNegPerm=R|M|W|U]="EdgeAccessVarNegPerm",o[o.EdgeAccessVarFuzPerm=R|M|K]="EdgeAccessVarFuzPerm",o[o.EdgeAccessVarPosTemp=R|M|L|z]="EdgeAccessVarPosTemp",o[o.EdgeAccessVarNegTemp=R|M|L|U]="EdgeAccessVarNegTemp",o[o.EdgeAccessVarFuzTemp=R|M|K]="EdgeAccessVarFuzTemp",o[o.Const=E]="Const",o[o.Var=R]="Var",o[o.Node=v]="Node",o[o.Link=ee]="Link",o[o.Unknown=0]="Unknown",o[o.NodeConst=v|E]="NodeConst",o[o.NodeVar=v|R]="NodeVar",o[o.LinkConst=ee|E]="LinkConst",o[o.LinkVar=ee|R]="LinkVar",o[o.NodeStruct=v|ne]="NodeStruct",o[o.NodeTuple=v|te]="NodeTuple",o[o.NodeRole=v|se]="NodeRole",o[o.NodeNoRole=v|re]="NodeNoRole",o[o.NodeClass=v|ie]="NodeClass",o[o.NodeAbstract=v|ae]="NodeAbstract",o[o.NodeMaterial=v|oe]="NodeMaterial",o[o.NodeConstStruct=v|E|ne]="NodeConstStruct",o[o.NodeConstTuple=v|E|te]="NodeConstTuple",o[o.NodeConstRole=v|E|se]="NodeConstRole",o[o.NodeConstNoRole=v|E|re]="NodeConstNoRole",o[o.NodeConstClass=v|E|ie]="NodeConstClass",o[o.NodeConstAbstract=v|E|ae]="NodeConstAbstract",o[o.NodeConstMaterial=v|E|oe]="NodeConstMaterial",o[o.NodeVarStruct=v|R|ne]="NodeVarStruct",o[o.NodeVarTuple=v|R|te]="NodeVarTuple",o[o.NodeVarRole=v|R|se]="NodeVarRole",o[o.NodeVarNoRole=v|R|re]="NodeVarNoRole",o[o.NodeVarClass=v|R|ie]="NodeVarClass",o[o.NodeVarAbstract=v|R|ae]="NodeVarAbstract",o[o.NodeVarMaterial=v|R|oe]="NodeVarMaterial",o[o._Edge=Q|B|M]="_Edge",o))(k||{});var ke=()=>({template:[],pre_template:[],buffer:[],bufferCurrent:"",bufferBranches:new Map,current:"",index:0,initial:"",branches:new Map,filteringTree:[],contentStack:new Map,contentAliases:new Set,addrFindValues:[],isDollar:!1,isReverse:!1,innerHats:[],linksToFill:{},globalAliases:{},aliasItems:new Map,edgeData:new Map,relations:[],getQuery:[]}),O=class l{static isInstanceFlag=Symbol();static[Symbol.hasInstance](e){return Object.hasOwn(e,l.isInstanceFlag)}},D=(l=!0)=>l?new Function:{},P=(l=ke(),e=!0)=>{let t=D(e);return Object.defineProperties(t,{...Object.fromEntries(Object.entries(l).map(([s,r])=>[s,{value:r,writable:!0}])),[O.isInstanceFlag]:{value:!0},resolveBuffer:{value(){this.buffer.length&&(this.template.push(...this.buffer),this.buffer=[],this.isReverse=!1),this.bufferCurrent&&(this.current=this.bufferCurrent,this.bufferCurrent="")}},createPushTemplateItem:{value(s,r,n,a){return this.resolveBuffer(),this.bufferBranches.set(r,{property:n,relationAlias:a}),i=>{this[s].push(i)}}},clone:{get(){return P({template:[...this.template],pre_template:[...this.pre_template],buffer:[...this.buffer],bufferCurrent:this.bufferCurrent,bufferBranches:new Map(this.bufferBranches),current:this.current,index:this.index,initial:this.initial,branches:new Map(this.branches),filteringTree:[...this.filteringTree],contentStack:new Map(this.contentStack),contentAliases:new Set(this.contentAliases),addrFindValues:[...this.addrFindValues],isDollar:this.isDollar,isReverse:this.isReverse,innerHats:[...this.innerHats],linksToFill:{...this.linksToFill},globalAliases:{...this.globalAliases},aliasItems:new Map(Array.from(this.aliasItems).map(([s,r])=>[s,r])),edgeData:new Map(this.edgeData),relations:[...this.relations],getQuery:[...this.getQuery]})}},currentItem:{get(){let s=this.bufferCurrent||this.current,r=this.current&&this.aliasItems.get(this.current);return s==="_"?(this.dynamicRoot||(this.dynamicRoot={type:"alias",value:s}),this.dynamicRoot):(r&&r.value===0&&(r.value=k.Var),typeof s=="string"?{type:"alias",value:s}:{type:"addr",value:s})}}}),t};import{signal as Me}from"@preact/signals";import{deepSignal as Pe}from"deepsignal";import{batch as Ae}from"@preact/signals";var de=(l,e,t)=>{if(t[_]){if(l[e][_]===t[_])return;l[e]=t;return}fe(l[e],t)},fe=(l,e)=>{if(typeof e!="object"||e===null){l.value=e;return}if(Array.isArray(e)){e.forEach((t,s)=>{s in l?typeof t!="object"||t===null?l[s]!==t&&(l[s]=t):de(l,s,t):l.push(t)}),l.length>e.length&&l.splice(e.length);return}for(let t in l)typeof l[t]=="object"&&t in e?de(l,t,e[t]):t in e&&l[t]!==e[t]&&(l[t]=e[t]);for(let t in e)t in l||(l[t]=e[t])},pe=(l,e)=>{Ae(()=>fe(e,l))};var le=new Map,me=async(l,e,t,s)=>{let r=le.get(e);r||le.set(e,r=new Map);let n=r.get(t);if(!n){r.set(t,n={id:0,listeners:new Set});let[a]=await l.subscribe([{addr:e,type:t}],()=>n.listeners.forEach(i=>i()));n.id=a}return n.listeners.add(s),async()=>{n.listeners.delete(s),n.listeners.size||(r.delete(t),await l.unsubscribe([n.id])),r.size||le.delete(e)}},j=new WeakMap,ce=new WeakMap,Te=l=>{for(let e of l)j.set(e,(j.get(e)??0)+1)},he=l=>{for(let e of l){let t=j.get(e);if(t>1)j.set(e,t-1);else{j.delete(e);let s=ce.get(e);if(s)for(let r of s)r()}}},He=(l,e)=>{Te(e);let t=l();return t instanceof Promise?t.then(s=>(he(e),s)):(he(e),t)},ye=async(l,e,t,s)=>{e.exposeResponse=!0;let r=await t,n=typeof r=="object"&&!r[_]?Pe(r):Me(r);return Ie(l,n,e,s),n},Ie=async(l,e,t,s)=>{let r=!1,n=!1,a=async()=>{if(r){n=!0;return}if(r=!0,j.get(e)){let c=ce.get(e);c||ce.set(e,c=[]),c.push(a),r=!1}else{let c=await s();pe(c,e),r=!1,n&&(n=!1,await a())}},i=$e(l,t,a);await i&&Object.defineProperties(e,{[Symbol.dispose]:{enumerable:!1,configurable:!0,value:()=>{i.then(c=>c()),console.debug("%cSynchronously cleaned up agents","color: grey")}},[Symbol.asyncDispose]:{enumerable:!1,configurable:!0,value:async()=>{await(await i)(),console.debug("%cAsynchronously cleaned up agents","color: grey")}}})},$e=async(l,e,t)=>{if(!e.exposedResponse)return;let s=[];for(let r of e.template)if(r[0].type==="addr"){let n=await r[0].value;s.push(me(l,n,"add_outgoing_edge",t)),s.push(me(l,n,"remove_outgoing_edge",t))}return console.debug(`%cCreated new agents (${s.length})`,"color: grey"),await Promise.all(s).then(r=>()=>(console.debug(`%cAsynchronously cleaned up agents (${r.length})`,"color: grey"),Promise.all(r.map(n=>n()))))};var $=async(l,e,t,s)=>await ye(l,e,t,s);var Z=Symbol(),Fe=(...l)=>({[Z]:l}),ge=l=>Z in l;async function ue(l){let e=[];for(let{searchTarget:t,current:s,key:r,isReverse:n,customRelation:a,dynamicRoot:i,insertPosition:c}of l.innerHats){if(r==="sc")continue;let d=t[_]?[t[_]]:await this.many(t[T],{addr:!0});l.current=s,l.isReverse=n,typeof i=="number"&&(l.current=e[i],l.relations.push(e[i]));for(let u of d){if(r==="from"||r==="to"){let g=l.edgeData.get(s);g?g[r==="from"?0:2]={type:"addr",value:u}:l.edgeData.set(s,[{type:"addr",value:u},l.aliasItems.get(s),{type:"addr",value:u}]),e.push("");continue}if(a&&i&&c!==void 0){let g=l.template.splice(c),h=this.addTemplateEntry(l,r,{type:"addr",value:u}),p=l.bufferBranches.get(h).relationAlias;e.push(p),i.value=p,l.resolveBuffer(),l.template.push(...g),l.relations.push(p)}else{let g=this.addTemplateEntry(l,r,{type:"addr",value:u}),h=l.bufferBranches.get(g).relationAlias;e.push(h)}}}l.template.unshift(...l.edgeData.values()),l.template.unshift(...l.pre_template),l.pre_template=[]}async function be(l,e,t){let s=await this.transformPromiseTemplate(l);if(!s)throw new Error("Failed to generate template");let r=await this.engine.send("generate_template",{templ:s}),n=Object.entries(l.linksToFill);n.length&&await this.engine.send("content:set",n.map(([c,{data:d,type:u}])=>({command:"set",addr:r.addrs[r.aliases[c]],type:u,data:d})));let a=e.map(c=>{let d=r.addrs[r.aliases[c]];if(!d)return;let u=P(void 0,!1);return u.current=d,u.relations=l.relations.map(g=>r.addrs[r.aliases[g]]),this.generate(u,d)});return Array.isArray(t)||Object.values(t).some(c=>Array.isArray(c))?a:a[0]}var q=Symbol(),T=Symbol(),_=Symbol(),J=(l,e)=>{let t=N.SupportedContetTypes.join(", ");if(e!==void 0&&!N.SupportedContetTypes.includes(e))throw new TypeError(`Invalid content type passed. Expected one of (${t}) but got '${e}'`);if(typeof l!="string"&&typeof l!="number")throw new TypeError(`Invalid type of content passed. Expected one of (${t}) but got ${typeof l}`);if((e==="int"||e==="float")&&typeof l!="number")throw new TypeError(`Invalid type of content passed. Expected ${e} but got ${typeof l}`);if(e==="string"&&typeof l!="string")throw new TypeError(`Invalid type of content passed. Expected ${e} but got ${typeof l}`)},X=class{constructor(e){this.engine=e}addTemplateEntry=(e,t,s,r=0,n="template")=>{let a=e.bufferCurrent||e.current;if(t==="is")return e.isReverse=!0,a;let i=(a instanceof Promise?a.idtf:a)+r,c=e.branches.get(`${i}.${+e.isReverse}.${t}`);if(c)return e.isReverse&&n==="template"&&(e.isReverse=!1),c;e.index++,s.type!=="alias"?(c=`_v${e.index}`,s.alias=c,e.aliasItems.set(c,s)):c=s.value,e.branches.set(`${i}.${+e.isReverse}.${t}`,c);let[d,u]=e.isReverse?[s,e.currentItem]:[e.currentItem,s];e.isReverse&&n==="template"&&(e.isReverse=!1);let g=`_e${e.index}`,h=e.createPushTemplateItem(n,c,t,g);if(t==="from"||t==="to"){let p=`_a${e.index}`;t==="from"?(e.branches.set(`${i}.${+e.isReverse}.to`,p),h([u,d,{type:"type",value:0,alias:p}])):(e.branches.set(`${i}.${+e.isReverse}.from`,p),h([{type:"type",value:0,alias:p},d,u]))}else if(t==="element")h([d,{type:"type",value:k.EdgeAccessVarPosPerm,alias:g},u]);else if(/^element[A-Z0-9_]/.test(t)){let p=`rrel${t.slice(7).replace(/[A-Z]+/g,m=>`_${m.toLowerCase()}`)}`;h([d,{type:"type",value:k.EdgeAccessVarPosPerm,alias:g},u]),h([{type:"addr",value:this.engine.getKeynode(p)},{type:"type",value:k.EdgeAccessVarPosPerm},{type:"alias",value:g}])}else{t==="name"&&u.type==="type"&&(u.value=k.LinkVar),h([d,{type:"type",value:k.EdgeDCommonVar,alias:g},u]);let p=this.engine.getKeynode(`nrel_${t==="name"?"main_idtf":t.replace(/[A-Z]+/g,m=>`_${m.toLowerCase()}`)}`);p.idtf=`nrel_${t==="name"?"main_idtf":t.replace(/[A-Z]+/g,m=>`_${m.toLowerCase()}`)}`,h([{type:"addr",value:p},{type:"type",value:k.EdgeAccessVarPosPerm},{type:"alias",value:g}])}return c};isObjectOrTrue=e=>e!==!0||typeof e!="object";processWhereQuery=(e,t)=>{};processWhere=(e,t,s)=>{let r=[],n=typeof t.alias=="string"&&t.alias.startsWith("%")&&t.alias;if(n){if(e.globalAliases[n])throw new Error("Alias already defined");e.globalAliases[n]=e.current}for(let[a,[i,c]]of Object.entries(t).entries()){if(c==null)continue;if(i==="sc"){let m=e.aliasItems.get(e.bufferCurrent||e.current);m.value=c;continue}let d=typeof c=="string"&&c.startsWith("%");if(i==="alias")continue;if(d&&!e.globalAliases[c])throw new Error("Alias cannot be referenced before its declaration");let u=d?{type:"alias",value:e.globalAliases[c]}:e.globalAliases[t.alias]?{type:"type",value:0,alias:e.globalAliases[t.alias]}:{type:"type",value:0},g=this.addTemplateEntry(e,i,u);s&&s.add(g);let h=(m,f)=>{let y=e.current;e.current=g;let x=this.processWhere(e,m,f??s);return e.current=y,x},p=m=>{let f=e.contentStack.get(m);return f||e.contentStack.set(m,f={content:m}),f};if(typeof c!="object"){r.push({type:"or",v:g,values:[p(c)]});continue}if(Array.isArray(c)){let m=[];for(let f of c){if(typeof f!="object"){m.push(p(f));continue}m.push({type:"and",values:h(f)})}r.push({type:"or",v:g,values:m});continue}if(ge(c)){let m=[],f=new Set;for(let y of c[Z]){if(typeof y!="object"){m.push(p(y));continue}m.push({type:"and",values:h(y,f)})}if(r.push({type:"and",v:g,values:m,subaliases:f}),s)for(let y of f)s.add(y);continue}r.push({type:"and",values:h(c)})}return r};buildGetQuery=(e,t,s)=>{let r=[];s??=r;for(let[n,a]of Object.entries(t)){if(n==="ref"){if(typeof a=="string")s.push([a,e.current,"ref"]);else{if(!this.isObjectOrTrue(a))continue;a===!0?r.push([n,e.current,"ref"]):a.addr===!0&&r.push([n,[["addr",e.current,"addr"]]]);let{addr:d}=a;typeof d=="string"&&s.push([d,e.current,"addr"])}continue}let i=e.current,c=n==="relation"&&e.bufferBranches.get(e.current)?.relationAlias||this.addTemplateEntry(e,n,{type:"type",value:0});if(typeof a=="object"){e.current=c;let d=this.buildGetQuery(e,a,s);d.length&&r.push([n,d]),e.current=i}else a===!0?r.push([n,c]):s.push([a,c])}return r};applyFilters=async(e,t)=>{if(!e.contentStack.size)return t;let s=Array.from(e.contentStack.keys()),r=await this.engine.send("content:find",s.map(a=>({command:"find",data:a})));for(let[a,i]of s.entries())e.contentStack.get(i).content=r[a];let n=(a,i)=>{if(i.type==="and"&&i.subaliases&&"v"in i){let c=[...i.values],d=t.addrs.filter(u=>{for(let[h,{relationAlias:p}]of e.bufferBranches)if(!(i.v===h||i.v===p)&&!(i.subaliases.has(h)||i.subaliases.has(p))&&(u[t.aliases[h]]!==a[t.aliases[h]]||u[t.aliases[p]]!==a[t.aliases[p]]))return!1;let g=c.findIndex(h=>{if("v"in i&&"content"in h)return h.content.includes(u[t.aliases[i.v]]);if("type"in h)return n(u,h)});return g===-1?!1:(c.splice(g,1),!0)});return d.length<i.values.length?!1:(t.addrs=t.addrs.filter(u=>!d.includes(u)),!0)}for(let c of i.values){let d;if("v"in i&&"content"in c?d=c.content.includes(a[t.aliases[i.v]]):"type"in c&&(d=n(a,c)),d){if(i.type==="or")return!0}else if(i.type==="and")return!1}return i.type!=="or"};return t.addrs=t.addrs.filter(a=>n(a,{values:e.filteringTree,type:"and"})),t};buildGetResponse=async(e,t,s,r)=>{let n={};return await Promise.all(e.map(async([a,i,c])=>{if(typeof i=="string"){let d=t[s[i]];if(c==="addr")n[a]=d;else if(c==="ref"){let u=P(void 0,!1);u.current=d,n[a]=this.generate(u,d)}else n[a]=await r(d,i)}else n[a]=await this.buildGetResponse(i,t,s,r)})),n};transformPromiseTemplate=async e=>(e.resolveBuffer(),await Promise.all(e.template.map(t=>Promise.all(t.map(async s=>({...s,value:await s.value}))))));async postget(e,t){let s=()=>{},r=new Promise(d=>s=d),n=[],a=(d,u)=>new Promise(g=>{let h=n.push(d);e.contentAliases.add(u),r.then(p=>g(p[h-1].value))}),i=Promise.all(t.addrs.map(d=>this.buildGetResponse(e.getQuery,d,t.aliases,a))),c=n.length?await this.engine.send("content:get",n.map(d=>({command:"get",addr:d}))):[];return s(c),await i}get(e,t=!1){let s=async r=>{e.resolveBuffer(),e.getQuery=t?this.buildGetQuery(e,{ref:r})[0][1]:this.buildGetQuery(e,r);let n=await this.transformPromiseTemplate(e);if(!n)return[];let a=await this.engine.send("search_template",{templ:n});return await this.applyFilters(e,a),e.exposeResponse&&(e.exposedResponse=a),this.postget(e,a)};return r=>{let n=s(r);return Object.defineProperty(n,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,e,n,s.bind(this,r))}),n}}link(e){return async(...t)=>{if(!t.length)return 0;let s=e.bufferBranches.get(e.bufferCurrent);if(!s)throw new Error("No buffer property found.");let r=s.property;e.buffer=[],e.bufferCurrent="";let n;if(e.template.length)n=await this.many(e,{addr:!0});else if(e.current)n=[e.current];else return 0;if(!n.length)return 0;let a=new Set,i=new Set,c,d;for(let[m,f]of t.entries())if(typeof f!="object"&&typeof f!="function"){J(f);let y=typeof f=="number"?Number.isInteger(f)?"int":"float":"string";a.add({data:f,type:y})}else if(f[T])for(let y of await f.ref.addr.many)i.add(y);else if(f[q]){let y=await f.create;if(Array.isArray(y))for(let{[_]:x}of y)i.add(x);else i.add(y[_])}else if(Array.isArray(f))for(let y of f)y[_]&&i.add(y[_]);else f[_]?i.add(f[_]):t.length===2&&m===1&&(d=f);let u=P();for(let m of n){u.current=m,u.isReverse=e.isReverse;let f="";for(let[y,x]of Array.from(i).entries())f=this.addTemplateEntry(u,r,{type:"addr",value:x},y);if(d&&f){let y=u.bufferBranches.get(f),x=u.current;u.current=y.relationAlias;let I=this.buildCreationTemplate(u,d,!1,!0);ue.call(this,u,I,d),c=u.current,u.current=x}for(let[y,x]of Array.from(a).entries()){let I=this.addTemplateEntry(u,r,{type:"type",value:k.LinkVar},y);u.linksToFill[I]=x}}let g=await this.transformPromiseTemplate(u);if(!g)throw new Error("Failed to generate template");let h=await this.engine.send("generate_template",{templ:g}),p=Object.entries(u.linksToFill);if(p.length&&await this.engine.send("content:set",p.map(([m,{data:f,type:y}])=>({command:"set",addr:h.addrs[h.aliases[m]],type:y,data:f}))),c){let m=h.addrs[h.aliases[c]],f=P(void 0,!1);return f.current=m,f.relations=e.relations.map(y=>h.addrs[h.aliases[y]]),this.generate(f,m)}return n.length*(i.size+a.size)}}unlink(e){return async(...t)=>{let s=e.bufferBranches.get(e.bufferCurrent);if(!s)throw new Error("No buffer property found.");let r=s.relationAlias,n=e.current,a=await this.transformPromiseTemplate(e);if(!a)return!1;let i=await this.engine.send("search_template",{templ:a}),c=p=>{let m=e.contentStack.get(p);return m||e.contentStack.set(p,m={content:p}),m},d=[];for(let p of t)typeof p=="object"||typeof p=="function"||d.push(c(p));if(d.length){let p=i.addrs;await this.applyFilters(e,i);let m=i.addrs.map(y=>y[i.aliases[n]]);i.addrs=p.filter(y=>m.includes(y[i.aliases[n]])),e.filteringTree=[{type:"and",v:e.current,values:d}],await this.applyFilters(e,i);let f=i.addrs.map(y=>y[i.aliases[r]]);return await this._deleteAddrs(f)}if(await this.applyFilters(e,i),!i.addrs.length)return 0;if(!t.length)return await this._deleteAddrs(i.addrs.map(p=>p[i.aliases[r]]));let u=i.addrs.map(p=>({addr:p[i.aliases[String(e.current)]],relation:p[i.aliases[r]]})),g=new Set;for(let p of t)if(!(typeof p!="object"&&typeof p!="function"))if(p[T])for(let m of await p.ref.addr.many)g.add(m);else for(let m of Array.isArray(p)?p:[p])m[_]&&g.add(m[_]);let h=u.reduce((p,m)=>(g.has(m.addr)&&p.push(m.relation),p),[]);return await this._deleteAddrs(h)}}update(e){return async(...t)=>{let s=()=>({linked:0,unlinked:0});if(!t.length)return s();let r=e.bufferBranches.get(e.bufferCurrent);if(!r)throw new Error("No buffer property found.");let n=r.property,a=r.relationAlias,i=e.clone;e.buffer=[],e.bufferCurrent="";let c;if(e.template.length)c=await this.many(e,{addr:!0});else if(e.current)c=[e.current];else return s();if(!c.length)return s();let d=new Set,u=new Set;for(let w of t)if(typeof w!="object"&&typeof w!="function"){J(w);let b=typeof w=="number"?Number.isInteger(w)?"int":"float":"string";d.add({data:w,type:b})}else if(w[T])for(let b of await w.ref.addr.many)u.add(b);else if(w[q]){let b=await w.create;if(Array.isArray(b))for(let{[_]:A}of b)u.add(A);else u.add(b[_])}else for(let b of Array.isArray(w)?w:[w])b[_]&&u.add(b[_]);let g=[],h=await this.transformPromiseTemplate(i);if(!h)return!1;let p=await this.engine.send("search_template",{templ:h});await this.applyFilters(i,p);for(let w of p.addrs){let b=w[p.aliases[String(i.current)]],A=w[p.aliases[a]];u.has(b)?u.delete(b):g.push(A)}let m=P();for(let w of c){m.current=w;for(let[b,A]of Array.from(u).entries())this.addTemplateEntry(m,n,{type:"addr",value:A},b);for(let[b,A]of Array.from(d).entries()){let H=this.addTemplateEntry(m,n,{type:"type",value:k.LinkVar},b);e.linksToFill[H]=A}}let f=await this.transformPromiseTemplate(m);if(!f)throw new Error("Failed to generate template");let y=await this.engine.send("generate_template",{templ:f}),x=Object.entries(e.linksToFill);x.length&&await this.engine.send("content:set",x.map(([w,{data:b,type:A}])=>({command:"set",addr:y.addrs[y.aliases[w]],type:A,data:b})));let I=await this._deleteAddrs(g);return{linked:c.length*(u.size+d.size),unlinked:I}}}async delete(e){let t=await this.many(e,{addr:!0});return await this._deleteAddrs(t)}async _deleteAddrs(e){return e.length?(await this.engine.send("delete_elements",e))[0]?e.length:!1:0}async one(e,t){let s=await this.transformPromiseTemplate(e);if(!s)return;let r=await this.engine.send("search_template",{templ:s});if(!r)throw new TypeError("There is likely an issue with sc-machine");await this.applyFilters(e,r),e.exposeResponse&&(e.exposedResponse=r);let n=r.addrs[0]?.[r.aliases[String(e.current)]];if(n)return t===!0?{addr:n}:t?.addr?n:(await this.engine.send("content:get",[{command:"get",addr:n}]))[0].value}async many(e,t){let s=await this.transformPromiseTemplate(e);if(!s)return[];let r=await this.engine.send("search_template",{templ:s});if(!r)throw new TypeError("There is likely an issue with sc-machine");await this.applyFilters(e,r),e.exposeResponse&&(e.exposedResponse=r);let n=r.addrs.map(a=>a[r.aliases[String(e.current)]]);return n.length?t===!0?n.map(a=>({addr:a})):t?.addr?n:(await this.engine.send("content:get",n.map(a=>({command:"get",addr:a})))).map(a=>a.value):[]}where(e,t){return s=>{let r=e.isReverse;if(Array.isArray(s)){let n=[];for(let a of s)if(a[T]){if(!a[T].initial)throw new TypeError("Query is not allowed to be used in filtering.");e.isReverse=!0,this.addTemplateEntry(e,"element",a[T].currentItem,0,"buffer")}else n.push({type:"and",values:this.processWhere(e,t?{ref:a}:a,e.contentAliases)});e.filteringTree.push({type:"or",values:n})}else if(s[T]){if(!s[T].initial)throw new TypeError("Query is not allowed to be used in filtering.");e.isReverse=!0,this.addTemplateEntry(e,"element",s[T].currentItem,0,"buffer")}else e.filteringTree.push(...this.processWhere(e,t?{ref:s}:s,e.contentAliases));return e.isReverse=r,t??this.generate(e)}}normalizeCombinations(e){let t=Object.entries(e),s=t.reduce((n,[,a])=>Array.isArray(a)?n*a.length:n,1),r=[];for(let n=0;n<s;n++){let a=[],i=s;t.forEach(([c,d])=>{Array.isArray(d)?(i/=d.length,a.push([c,d[Math.floor(n/i)%d.length]])):a.push([c,d])}),r.push(a)}return r}buildCreationTemplate(e,t,s=!1,r=!1,n){let a=[],i=Array.isArray(t)?t:[t];for(let[c,d]of i.entries()){if(d instanceof O)continue;let u=this.normalizeCombinations(d);for(let[g,h]of u.entries()){let p=e.current;if(!s&&!r){e.index++;let m=`_c${e.index}`,f=Object.fromEntries(h);if("sc"in f&&f.sc&k._Edge){if(!f.from)throw new TypeError("Cannot create an edge without 'from' property");if(!f.to)throw new TypeError("Cannot create an edge without 'to' property");e.aliasItems.set(m,{type:"type",value:f.sc,alias:m})}else{if(f.from)throw new TypeError("Cannot use 'from' property with a non-edge element");if(f.to)throw new TypeError("Cannot use 'to' property with a non-edge element")}e.template.push([e.currentItem,{type:"type",value:k.EdgeAccessVarPosPerm},f.from?{type:"alias",value:m}:{type:"type",value:f.sc??k.NodeVar,alias:m}]),a.push(m),e.current=m}for(let[m,[f,y]]of h.entries()){if(f==="is"){this.buildCreationTemplate(e,y,!0,r);continue}if(typeof y=="object"||typeof y=="function"){let x=null,I,w;if(!y[q]&&Object.keys(y).length===2&&"value"in y&&"relation"in y){x=y.relation,y=y.value;let b=e.current;e.current="_",I=e.template.length;let A=e.innerHats.length;this.buildCreationTemplate(e,x,!1,!0,A),A!==e.innerHats.length&&(w=e.innerHats.splice(A)),e.current=b}if(y instanceof O)e.innerHats.push({searchTarget:y,current:e.current,key:f,isReverse:s,customRelation:x,dynamicRoot:n??e.dynamicRoot,insertPosition:I}),w&&e.innerHats.push(...w);else{let{target:b,aliases:A}=y[q],H=(m*u.length+g)*i.length+c;Object.getOwnPropertyDescriptor(b,"resolveBuffer").value.call(b);let Y=Object.getOwnPropertyDescriptor(b,"template").value;Y.forEach(F=>F.forEach(C=>{C.type==="alias"?C.value=H+C.value:C.alias&&(C.alias=H+C.alias)})),f==="from"||f==="to"?e.pre_template.push(...Y):e.template.push(...Y);let ve=Object.getOwnPropertyDescriptor(b,"linksToFill").value;for(let[F,C]of Object.entries(ve))e.linksToFill[H+F]=C;let _e=Object.getOwnPropertyDescriptor(b,"innerHats").value;for(let{searchTarget:F,current:C,key:V,isReverse:xe}of _e)e.innerHats.push({searchTarget:F,current:H+C,key:V,isReverse:xe});for(let[F,C]of A.entries()){if(f==="from"||f==="to"){let V=e.edgeData.get(C);V?V[f==="from"?0:2].value=H+C:e.edgeData.set(C,V=[{type:"alias",value:H+C},e.aliasItems.get(C),{type:"alias",value:H+C}]);continue}this.addTemplateEntry(e,f,{type:"alias",value:H+C},F)}}}else{if(f==="sc"||f==="from"||f==="to")continue;e.isReverse=s;let x=this.addTemplateEntry(e,f,{type:"type",value:k.LinkVar});J(y);let I=typeof y=="number"?Number.isInteger(y)?"int":"float":"string";e.linksToFill[x]={data:y,type:I}}}e.current=p}}return a}generate(e=P(),t){return t&&Object.defineProperty(e,"ref",{configurable:!0,writable:!1,enumerable:!0,value:{addr:t}}),new Proxy(e,{construct:(s,r)=>{if(s.template.length||s.isReverse||s.isDollar||!s.current)throw new TypeError("Unexpected constructor call");if(r.length&&r.length!==1)throw new TypeError("Concept constructor expects only 1 argument");let n=s.clone,a=r[0]??{},i=this.buildCreationTemplate(n,a);return new Proxy(D(),{get:(c,d)=>{switch(d){case q:return{target:n,aliases:i};case"create":return(async()=>(await ue.call(this,n),await be.call(this,n,i,a)))()}}})},get:(s,r)=>{if(r==="constructor")return;if(r==="valueOf")return()=>"Magic Query";if(r==="toString")return"hola";if(r==="then")return;if(r===_)return t;if(r===T&&!t)return s;if(typeof r=="symbol")return;if(!s.current){let i=s.clone,c=r.match(/^Element(([A-Z0-9_]|$).+)/);if(c){let u=`rrel${c[1].replace(/[A-Z]+/g,g=>`_${g.toLowerCase()}`)}`;return i.current=this.engine.getKeynode(u),i.current.idtf=u,i.initial=u,this.generate(i)}let d=`${r.replace(/[A-Z]+/g,u=>`_${u.toLowerCase()}`)}`;return i.current=this.engine.getKeynode(`concept${d}`),i.current.idtf=`concept${d}`,i.initial=d.slice(1),this.generate(i)}if(r==="$"){let i=s.clone;return i.isDollar=!0,this.generate(i)}if(t&&r==="relations")return s.relations;let n=s.clone;if(r==="relation"){n.resolveBuffer();let i=n.bufferBranches.get(n.current).relationAlias;return n.current=i,this.generate(n)}if(r==="one"){n.contentAliases.add(n.bufferCurrent||n.current);let i=this.one(n);return Object.defineProperty(i,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,n,i,this.one.bind(this,n))}),i}if(r==="many"){n.contentAliases.add(n.bufferCurrent||n.current);let i=this.many(n);return Object.defineProperty(i,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,n,i,this.many.bind(this,n))}),i}if(r==="write")return async(i,c)=>{J(i,c),c??=typeof i=="number"?Number.isInteger(i)?"int":"float":"string";let d=await this.many(n.clone,{addr:!0});return d.length?(await this.engine.send("content:set",d.map(u=>({command:"set",addr:u,data:i,type:c}))),d.length):await this.link(n)(i)};if(r==="get")return this.get(n);if(r==="where")return this.where(n);if(r==="link")return this.link(n);if(r==="unlink")return this.unlink(n);if(r==="update")return this.update(n);if(r==="ref"){let i=new Proxy(t?{addr:t}:D(),{get:(c,d)=>{switch(d){case"addr":return t||new Proxy(D(),{get:(u,g)=>{switch(g){case"one":{let h=this.one(n,{addr:!0});return Object.defineProperty(h,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,n,h,this.one.bind(this,n,{addr:!0}))}),h}case"many":{let h=this.many(n,{addr:!0});return Object.defineProperty(h,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,n,h,this.many.bind(this,n,{addr:!0}))}),h}}}});case"one":{if(t)return;let u=async()=>{let h=await this.one(n,{addr:!0});if(!h)return;let p=P(void 0,!1);return p.current=h,this.generate(p,h)},g=u();return Object.defineProperty(g,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,n,g,u)}),g}case"many":{if(t)return;let u=async()=>(await this.many(n,{addr:!0})).map(p=>{let m=P(void 0,!1);return m.current=p,this.generate(m,p)}),g=u();return Object.defineProperty(g,"reactive",{enumerable:!1,configurable:!1,get:()=>$(this.engine,n,g,u)}),g}case"where":return t?void 0:this.where(n,i);case"get":return t?void 0:this.get(n,!0);case"delete":return t?this._deleteAddrs([t]):this.delete(n)}}});return i}if(r==="clone")return n.clone;if(r==="scs")return n;let a=this.addTemplateEntry(n,r,{type:"type",value:0},0,"buffer");return n.bufferCurrent=a,this.generate(n)},apply:(s,r,n)=>{if(!n.length)return;if(!s.initial&&!s.isDollar)throw new TypeError("System idtf can only be accessed from the first element of the chain");if(n[1]!==void 0){if(typeof n[1]=="number"){let u=P(void 0,!1);return u.current=n[1],this.generate(u,n[1])}let d=`Expected number but got ${typeof n[1]}: ${JSON.stringify(n[1])}`;throw new TypeError(`Invalid type of sc-addr specified. ${d}.`)}let a=s.clone;a.index++;let i=`_v${a.index}`,c=a.isDollar?n[0][0]:`${a.initial}_${n[0][0]}`;return a.template.push([a.currentItem,{type:"type",value:k.EdgeAccessVarPosPerm},{type:"addr",value:this.engine.getKeynode(c),alias:i}]),a.initial="",a.isDollar=!1,a.current=i,this.generate(a)}})}};import{Signal as wt,batch as vt,computed as _t,effect as xt,signal as Ct,untracked as Et}from"@preact/signals";import{deepSignal as kt}from"deepsignal";var we=class{engine;magicModule;constructor(e,t){this.engine=new G(e,t),this.magicModule=new X(this.engine)}get magic(){return this.magicModule.generate()}$disconnect(){return this.engine.disconnect()}[Symbol.dispose](){return this.engine.disconnect()}async[Symbol.asyncDispose](){return await this.engine.disconnect()}};export{Fe as $and,we as Enneract,k as ScType,wt as Signal,vt as batch,_t as computed,kt as deepSignal,xt as effect,Ct as signal,He as smartBatch,Et as untracked};
